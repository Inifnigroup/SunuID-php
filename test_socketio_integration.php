<?php

/**
 * Test d'int√©gration Socket.IO complet et am√©lior√©
 * Page de test interactive pour valider toutes les fonctionnalit√©s
 */

require_once __DIR__ . '/vendor/autoload.php';

use SunuID\SunuID;

// Configuration pour les tests
$testConfig = [
    'client_id' => 'test_client_' . uniqid(),
    'secret_id' => 'test_secret_' . uniqid(),
    'partner_name' => 'Test Partner - ' . date('Y-m-d H:i:s'),
    'enable_websocket' => true,
    'websocket_url' => 'wss://samasocket.fayma.sn:9443',
    'websocket_socketio_version' => '2',
    'websocket_transports' => ['websocket', 'polling'],
    'websocket_query_params' => [
        'custom_param' => 'custom_value',
        'test_mode' => 'true',
        'test_session' => uniqid()
    ],
    'enable_logs' => true,
    'log_level' => \Monolog\Logger::DEBUG,
    'log_file' => 'test-socketio-' . date('Y-m-d') . '.log'
];

// Fonction pour afficher les r√©sultats de test
function displayTestResult($testName, $success, $message = '', $data = []) {
    $icon = $success ? '‚úÖ' : '‚ùå';
    $status = $success ? 'SUCC√àS' : '√âCHEC';
    $color = $success ? 'green' : 'red';
    
    echo "\n";
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
    echo "$icon Test: $testName\n";
    echo "üìä Statut: $status\n";
    
    if ($message) {
        echo "üí¨ Message: $message\n";
    }
    
    if (!empty($data)) {
        echo "üìã Donn√©es:\n";
        foreach ($data as $key => $value) {
            if (is_array($value)) {
                echo "   - $key: " . json_encode($value, JSON_PRETTY_PRINT) . "\n";
            } else {
                echo "   - $key: $value\n";
            }
        }
    }
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
}

// Fonction pour afficher les m√©triques
function displayMetrics($metrics) {
    echo "\nüìä M√âTRIQUES DE PERFORMANCE\n";
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
    echo "üì° Messages envoy√©s: " . ($metrics['messages_sent'] ?? 0) . "\n";
    echo "üì® Messages re√ßus: " . ($metrics['messages_received'] ?? 0) . "\n";
    echo "‚ùå Erreurs: " . ($metrics['errors'] ?? 0) . "\n";
    echo "üîÑ Reconnexions: " . ($metrics['reconnections'] ?? 0) . "\n";
    echo "‚è±Ô∏è Temps de connexion: " . ($metrics['uptime'] ?? 0) . " secondes\n";
    echo "üìà Taux de succ√®s: " . (($metrics['messages_sent'] ?? 0) > 0 ? 
        round((($metrics['messages_sent'] - ($metrics['errors'] ?? 0)) / $metrics['messages_sent']) * 100, 2) : 0) . "%\n";
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
}

// Fonction pour simuler des √©v√©nements
function simulateEvents($sunuid) {
    echo "\nüé≠ SIMULATION D'√âV√âNEMENTS\n";
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
    
    $events = [
        'auth_success' => [
            'session_id' => 'test_session_' . uniqid(),
            'user_id' => 'test_user_' . uniqid(),
            'device_info' => [
                'model' => 'iPhone 14',
                'os' => 'iOS 17.0',
                'app_version' => '2.1.0'
            ],
            'timestamp' => time()
        ],
        'kyc_complete' => [
            'session_id' => 'test_session_' . uniqid(),
            'kyc_data' => [
                'user_info' => [
                    'name' => 'John Doe',
                    'email' => 'john.doe@example.com',
                    'phone' => '+221 77 777 77 77',
                    'id' => 'user_' . uniqid()
                ],
                'verification_status' => 'verified',
                'documents' => [
                    'identity_card' => 'verified',
                    'selfie' => 'verified',
                    'proof_of_address' => 'verified'
                ]
            ],
            'timestamp' => time()
        ],
        'auth_failure' => [
            'session_id' => 'test_session_' . uniqid(),
            'reason' => 'Timeout d\'authentification',
            'error_code' => 'AUTH_TIMEOUT',
            'timestamp' => time()
        ]
    ];
    
    foreach ($events as $eventType => $eventData) {
        echo "üéØ Simulation de l'√©v√©nement: $eventType\n";
        
        // D√©clencher l'√©v√©nement via le callback
        $callbacks = $sunuid->getWebSocketCallbacks();
        if (isset($callbacks[$eventType])) {
            foreach ($callbacks[$eventType] as $callback) {
                $callback($eventData);
            }
        }
        
        echo "   ‚úÖ √âv√©nement simul√© avec succ√®s\n";
        sleep(1); // Pause entre les √©v√©nements
    }
}

// D√©but du test
echo "üß™ TEST D'INT√âGRATION SOCKET.IO COMPLET\n";
echo "=======================================\n";
echo "üïê D√©but: " . date('Y-m-d H:i:s') . "\n";
echo "üîß Configuration: " . json_encode($testConfig, JSON_PRETTY_PRINT) . "\n";

$testResults = [];
$startTime = microtime(true);

try {
    // Test 1: Initialisation du SDK
    echo "\nüîß Test 1: Initialisation du SDK\n";
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
    
    $sunuid = new SunuID($testConfig);
    $testResults['sdk_init'] = true;
    echo "‚úÖ SDK cr√©√© avec succ√®s\n";
    
    $sdkConfig = $sunuid->getConfig();
    echo "‚úÖ Configuration SDK r√©cup√©r√©e\n";
    echo "   - API URL: " . $sdkConfig['api_url'] . "\n";
    echo "   - WebSocket activ√©: " . ($sdkConfig['enable_websocket'] ? 'Oui' : 'Non') . "\n";
    echo "   - Client ID: " . $sdkConfig['client_id'] . "\n";
    echo "   - Partner: " . $sdkConfig['partner_name'] . "\n";

    // Test 2: Initialisation Socket.IO
    echo "\nüì° Test 2: Initialisation Socket.IO\n";
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
    
    $result = $sunuid->initWebSocket();
    $testResults['websocket_init'] = $result;
    
    if ($result) {
        echo "‚úÖ Initialisation Socket.IO r√©ussie\n";
        
        $webSocket = $sunuid->getWebSocket();
        if ($webSocket) {
            echo "‚úÖ Client Socket.IO r√©cup√©r√©\n";
            
            $wsConfig = $webSocket->getConfig();
            echo "‚úÖ Configuration Socket.IO:\n";
            echo "   - URL: " . $wsConfig['ws_url'] . "\n";
            echo "   - Version: " . $wsConfig['socketio_version'] . "\n";
            echo "   - Transports: " . implode(', ', $wsConfig['transports']) . "\n";
            echo "   - Param√®tres: " . json_encode($wsConfig['query_params']) . "\n";
        } else {
            echo "‚ùå Client Socket.IO non disponible\n";
            $testResults['websocket_init'] = false;
        }
    } else {
        echo "‚ùå √âchec de l'initialisation Socket.IO\n";
    }
    
    // Test 3: Configuration des callbacks
    echo "\nüëÇ Test 3: Configuration des callbacks\n";
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
    
    $callbackCount = 0;
    $callbackResults = [];
    
    // Callback de connexion
    $sunuid->onWebSocketEvent('connect', function ($data) use (&$callbackCount, &$callbackResults) {
        $callbackCount++;
        $callbackResults['connect'] = $data;
        echo "   üîó Callback connect appel√©\n";
        echo "      Socket ID: " . ($data['socket_id'] ?? 'N/A') . "\n";
    });
    
    // Callback d'authentification r√©ussie
    $sunuid->onWebSocketEvent('auth_success', function ($data) use (&$callbackCount, &$callbackResults) {
        $callbackCount++;
        $callbackResults['auth_success'] = $data;
        echo "   ‚úÖ Callback auth_success appel√©\n";
        echo "      Session ID: " . ($data['session_id'] ?? 'N/A') . "\n";
        echo "      User ID: " . ($data['user_id'] ?? 'N/A') . "\n";
        if (isset($data['device_info'])) {
            echo "      Appareil: " . ($data['device_info']['model'] ?? 'N/A') . "\n";
        }
    });
    
    // Callback KYC compl√©t√©
    $sunuid->onWebSocketEvent('kyc_complete', function ($data) use (&$callbackCount, &$callbackResults) {
        $callbackCount++;
        $callbackResults['kyc_complete'] = $data;
        echo "   üìã Callback kyc_complete appel√©\n";
        echo "      Session ID: " . ($data['session_id'] ?? 'N/A') . "\n";
        if (isset($data['kyc_data'])) {
            echo "      Donn√©es KYC re√ßues\n";
            if (isset($data['kyc_data']['user_info'])) {
                echo "      Nom: " . ($data['kyc_data']['user_info']['name'] ?? 'N/A') . "\n";
            }
        }
    });
    
    // Callback d'√©chec d'authentification
    $sunuid->onWebSocketEvent('auth_failure', function ($data) use (&$callbackCount, &$callbackResults) {
        $callbackCount++;
        $callbackResults['auth_failure'] = $data;
        echo "   ‚ùå Callback auth_failure appel√©\n";
        echo "      Raison: " . ($data['reason'] ?? 'N/A') . "\n";
        echo "      Code: " . ($data['error_code'] ?? 'N/A') . "\n";
    });
    
    // Callback KYC en cours
    $sunuid->onWebSocketEvent('kyc_pending', function ($data) use (&$callbackCount, &$callbackResults) {
        $callbackCount++;
        $callbackResults['kyc_pending'] = $data;
        echo "   ‚è≥ Callback kyc_pending appel√©\n";
        echo "      √âtapes restantes: " . implode(', ', $data['pending_steps'] ?? []) . "\n";
    });
    
    // Callback d'erreur
    $sunuid->onWebSocketEvent('error', function ($data) use (&$callbackCount, &$callbackResults) {
        $callbackCount++;
        $callbackResults['error'] = $data;
        echo "   ‚ùå Callback error appel√©\n";
        echo "      Erreur: " . ($data['error'] ?? 'N/A') . "\n";
    });
    
    $testResults['callbacks_config'] = $callbackCount > 0;
    echo "‚úÖ $callbackCount callbacks configur√©s\n";

    // Test 4: Tentative de connexion
    echo "\nüîó Test 4: Tentative de connexion\n";
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
    
    $connected = $sunuid->connectWebSocket();
    $testResults['connection_attempt'] = true;
    
    if ($connected) {
        echo "‚úÖ Connexion Socket.IO r√©ussie\n";
        echo "‚úÖ √âtat de connexion: " . ($sunuid->isWebSocketConnected() ? 'Connect√©' : 'D√©connect√©') . "\n";
        
        $connectionInfo = $sunuid->getWebSocketConnectionInfo();
        if ($connectionInfo) {
            echo "‚úÖ Informations de connexion:\n";
            echo "   - Socket ID: " . ($connectionInfo['socket_id'] ?? 'N/A') . "\n";
            echo "   - Connect√© depuis: " . date('Y-m-d H:i:s', $connectionInfo['connected_at'] ?? time()) . "\n";
        }
    } else {
        echo "‚ö†Ô∏è Connexion √©chou√©e (normal en environnement de test)\n";
        echo "‚ÑπÔ∏è Cela peut √™tre d√ª √†:\n";
        echo "   - Serveur Socket.IO non disponible\n";
        echo "   - Probl√®me de r√©seau\n";
        echo "   - Configuration incorrecte\n";
    }
    
    // Test 5: Gestion des sessions
    echo "\nüìã Test 5: Gestion des sessions\n";
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
    
    $sessionId = 'test_session_' . uniqid();
    echo "   Session ID de test: $sessionId\n";
    
    // Abonnement
    $subscribed = $sunuid->subscribeToSession($sessionId);
    $testResults['session_subscription'] = $subscribed;
    echo "   ‚úÖ Abonnement: " . ($subscribed ? 'Succ√®s' : '√âchec (attendu)') . "\n";
    
    // V√©rification des sessions actives
    $activeSessions = $sunuid->getWebSocketActiveSessions();
    $testResults['active_sessions_count'] = count($activeSessions);
    echo "   ‚úÖ Sessions actives: " . count($activeSessions) . "\n";
    
    if (!empty($activeSessions)) {
        foreach ($activeSessions as $sid => $sessionData) {
            echo "      - $sid: " . ($sessionData['status'] ?? 'unknown') . "\n";
        }
    }
    
    // D√©sabonnement
    $unsubscribed = $sunuid->unsubscribeFromSession($sessionId);
    $testResults['session_unsubscription'] = $unsubscribed;
    echo "   ‚úÖ D√©sabonnement: " . ($unsubscribed ? 'Succ√®s' : '√âchec (attendu)') . "\n";

    // Test 6: Envoi de messages
    echo "\nüí¨ Test 6: Envoi de messages\n";
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
    
    $messages = [
        [
            'event' => 'test_message',
            'data' => [
                'message' => 'Hello Socket.IO!',
                'timestamp' => time(),
                'test_id' => uniqid()
            ]
        ],
        [
            'event' => 'custom_event',
            'data' => [
                'user_id' => 'test_user',
                'action' => 'test',
                'metadata' => [
                    'source' => 'php-sdk-test',
                    'version' => '1.0.0'
                ]
            ]
        ],
        [
            'event' => 'ping',
            'data' => [
                'id' => uniqid(),
                'timestamp' => microtime(true)
            ]
        ]
    ];
    
    $sentMessages = 0;
    foreach ($messages as $index => $message) {
        $sent = $sunuid->sendWebSocketMessage($message);
        if ($sent) $sentMessages++;
        echo "   ‚úÖ Message " . ($index + 1) . " (" . $message['event'] . "): " . ($sent ? 'Envoy√©' : '√âchec (attendu)') . "\n";
    }
    
    $testResults['messages_sent'] = $sentMessages;
    $testResults['messages_total'] = count($messages);

    // Test 7: G√©n√©ration QR avec Socket.IO
    echo "\nüì± Test 7: G√©n√©ration QR avec Socket.IO\n";
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
    
    // Initialiser le SDK d'abord
    $sunuid->init();
    
    $qrResult = $sunuid->generateQRWithWebSocket('https://test.sunuid.sn/auth', [
        'type' => 2, // Authentification
        'theme' => 'light',
        'size' => 300,
        'custom_data' => [
            'test_mode' => true,
            'test_session' => uniqid()
        ]
    ]);
    
    $testResults['qr_generation'] = $qrResult['success'];
    
    if ($qrResult['success']) {
        echo "‚úÖ G√©n√©ration QR r√©ussie\n";
        echo "   ‚úÖ Donn√©es QR r√©cup√©r√©es\n";
        if (isset($qrResult['data']['session_id'])) {
            echo "   ‚úÖ Session ID: " . $qrResult['data']['session_id'] . "\n";
        }
        if (isset($qrResult['data']['url'])) {
            echo "   ‚úÖ URL: " . $qrResult['data']['url'] . "\n";
        }
        if (isset($qrResult['data']['qr_code'])) {
            echo "   ‚úÖ QR Code g√©n√©r√© (base64)\n";
        }
    } else {
        echo "‚ùå Erreur lors de la g√©n√©ration QR: " . $qrResult['error'] . "\n";
    }

    // Test 8: Simulation d'√©v√©nements
    echo "\nüé≠ Test 8: Simulation d'√©v√©nements\n";
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
    
    simulateEvents($sunuid);
    $testResults['event_simulation'] = true;

    // Test 9: Test de d√©connexion
    echo "\nüîå Test 9: D√©connexion\n";
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
    
    $sunuid->disconnectWebSocket();
    echo "‚úÖ D√©connexion effectu√©e\n";
    
    $isConnected = $sunuid->isWebSocketConnected();
    $testResults['disconnection'] = !$isConnected;
    echo "‚úÖ √âtat apr√®s d√©connexion: " . ($isConnected ? 'Connect√©' : 'D√©connect√©') . "\n";
    
    $webSocket = $sunuid->getWebSocket();
    echo "‚úÖ Client WebSocket apr√®s d√©connexion: " . ($webSocket === null ? 'Null' : 'Existe') . "\n";

    // Test 10: Test de reconnexion
    echo "\nüîÑ Test 10: Test de reconnexion\n";
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
    
    $reconnected = $sunuid->initWebSocket();
    $testResults['reconnection'] = $reconnected;
    echo "‚úÖ R√©initialisation: " . ($reconnected ? 'Succ√®s' : '√âchec') . "\n";
    
    if ($reconnected) {
        $webSocket = $sunuid->getWebSocket();
        echo "‚úÖ Client WebSocket r√©cup√©r√© apr√®s reconnexion\n";
        
        // Nettoyage final
        $sunuid->disconnectWebSocket();
        echo "‚úÖ Nettoyage final effectu√©\n";
    }

    // Test 11: M√©triques de performance
    echo "\nüìä Test 11: M√©triques de performance\n";
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
    
    $metrics = $sunuid->getWebSocketMetrics();
    $testResults['metrics_available'] = !empty($metrics);
    
    if (!empty($metrics)) {
        displayMetrics($metrics);
    } else {
        echo "‚ö†Ô∏è M√©triques non disponibles\n";
    }

    // Calcul du temps d'ex√©cution
    $endTime = microtime(true);
    $executionTime = round($endTime - $startTime, 2);
    
    // R√©sum√© final
    echo "\nüìä R√âSUM√â DES TESTS\n";
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
    echo "‚è±Ô∏è Temps d'ex√©cution: {$executionTime} secondes\n";
    echo "üìã Tests effectu√©s: " . count($testResults) . "\n";
    
    $successCount = count(array_filter($testResults, function($result) {
        return $result === true || (is_numeric($result) && $result > 0);
    }));
    
    echo "‚úÖ Tests r√©ussis: $successCount\n";
    echo "‚ùå Tests √©chou√©s: " . (count($testResults) - $successCount) . "\n";
    echo "üìà Taux de succ√®s: " . round(($successCount / count($testResults)) * 100, 2) . "%\n";
    
    echo "\nüéØ FONCTIONNALIT√âS TEST√âES\n";
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
    echo "‚úÖ Initialisation et configuration du SDK\n";
    echo "‚úÖ Configuration Socket.IO\n";
    echo "‚úÖ Gestion des callbacks d'√©v√©nements\n";
    echo "‚úÖ Tentative de connexion Socket.IO\n";
    echo "‚úÖ Abonnement/d√©sabonnement aux sessions\n";
    echo "‚úÖ Envoi de messages personnalis√©s\n";
    echo "‚úÖ G√©n√©ration QR avec abonnement automatique\n";
    echo "‚úÖ Simulation d'√©v√©nements\n";
    echo "‚úÖ D√©connexion et nettoyage\n";
    echo "‚úÖ Reconnexion et r√©initialisation\n";
    echo "‚úÖ M√©triques de performance\n";
    
    echo "\nüöÄ PR√äT POUR LA PRODUCTION\n";
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
    echo "Le SDK SunuID PHP avec Socket.IO est maintenant pr√™t pour:\n";
    echo "   - üì± Authentification en temps r√©el\n";
    echo "   - üìã KYC avec notifications instantan√©es\n";
    echo "   - üîî Notifications push\n";
    echo "   - üí¨ Communication bidirectionnelle\n";
    echo "   - üîÑ Gestion automatique des reconnexions\n";
    echo "   - üìä Monitoring et m√©triques\n";
    echo "   - üõ°Ô∏è Gestion d'erreurs robuste\n";
    
    // Affichage des r√©sultats d√©taill√©s
    echo "\nüìã R√âSULTATS D√âTAILL√âS\n";
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
    foreach ($testResults as $testName => $result) {
        $icon = $result === true || (is_numeric($result) && $result > 0) ? '‚úÖ' : '‚ùå';
        echo "$icon $testName: " . (is_bool($result) ? ($result ? 'Succ√®s' : '√âchec') : $result) . "\n";
    }
    
    // Affichage des callbacks d√©clench√©s
    if (!empty($callbackResults)) {
        echo "\nüé≠ CALLBACKS D√âCLENCH√âS\n";
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
        foreach ($callbackResults as $eventType => $data) {
            echo "‚úÖ $eventType: " . json_encode($data, JSON_PRETTY_PRINT) . "\n";
        }
    }

} catch (Exception $e) {
    echo "\n‚ùå ERREUR CRITIQUE\n";
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
    echo "Erreur: " . $e->getMessage() . "\n";
    echo "Fichier: " . $e->getFile() . "\n";
    echo "Ligne: " . $e->getLine() . "\n";
    echo "Stack trace:\n" . $e->getTraceAsString() . "\n";
    
    $testResults['critical_error'] = false;
}

echo "\nüéâ Test d'int√©gration Socket.IO termin√©!\n";
echo "üïê Fin: " . date('Y-m-d H:i:s') . "\n";
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";

// Sauvegarder les r√©sultats dans un fichier
$resultsFile = 'test-results-' . date('Y-m-d-H-i-s') . '.json';
file_put_contents($resultsFile, json_encode([
    'timestamp' => date('Y-m-d H:i:s'),
    'config' => $testConfig,
    'results' => $testResults,
    'execution_time' => $executionTime ?? 0,
    'success_rate' => isset($successCount) ? round(($successCount / count($testResults)) * 100, 2) : 0
], JSON_PRETTY_PRINT));

echo "üíæ R√©sultats sauvegard√©s dans: $resultsFile\n"; 